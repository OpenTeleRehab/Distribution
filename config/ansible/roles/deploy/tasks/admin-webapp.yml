---

- name: Login to nexus docker private repo
  docker_login:
    registry: '{{ hub_registry }}'
    username: '{{ hub_user }}'
    password: '{{ hub_pass }}'

- name: Clone Admin webapp repos
  git:
    repo: git@git.web-essentials.asia:hiv-tra-20/admin-web-app.git
    dest: '{{ workspace }}/admin-webapp'
    accept_hostkey: yes
    version: master
    force: yes

- name: Create configuration teamplates
  template:
    src: '{{ item }}'
    dest: '{{ workspace }}/admin-webapp/{{ item | basename | regex_replace("\.j2$", "") }}'
    mode: 0755
  with_fileglob:
    - '../templates/internal/admin-webapp/*.j2'

- name: Run npm install
  shell: npm install
  args:
    chdir: '{{ workspace }}/admin-webapp'

- name: Run yarn build
  shell: yarn build
  args:
    chdir: '{{ workspace }}/admin-webapp'

- name: Build docker image
  shell: 'docker build -t {{ stage }}-admin-webapp:latest .'
  args:
    chdir: '{{ workspace }}/admin-webapp'
  when: lookup('env', 'JENKINS_HOME')

- name: Tag docker image to hub.web-essentials.co
  shell: 'docker tag {{ stage }}-admin-webapp:latest {{ image_name }}/{{ stage }}/admin-webapp:{{ item }}'
  args:
    chdir: '{{ workspace }}/admin-webapp'
  loop:
    - '{{ version }}'
    - latest
  when: lookup('env', 'JENKINS_HOME')

- name: Push docker image to hub.web-essentials.co
  shell: 'docker push {{ image_name }}/{{ stage }}/admin-webapp:{{ item }}'
  args:
    chdir: '{{ workspace }}/admin-webapp'
  loop:
    - '{{ version }}'
    - latest
  when: lookup('env', 'JENKINS_HOME')
