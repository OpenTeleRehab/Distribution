---

- name: Run common requirement task
  import_tasks: common.yml
  when: stage != 'live'

- name: Build Admin service
  import_tasks: admin-service.yml
  when: stage != 'live'

- name: Build Admin webapp
  import_tasks: admin-webapp.yml
  when: stage != 'live'

- name: Build Therapist service
  import_tasks: therapist-service.yml
  when: stage != 'live'

- name: Build Therapist webapp
  import_tasks: therapist-webapp.yml
  when: stage != 'live'

- name: Deploy deploy services
  import_tasks: deploy-services.yml
  when: stage != 'live'

- name: Copy Dockerfile
  template:
    src: '{{  item }}.j2'
    dest: '{{ workspace }}/{{ item }}'
    mode: 0755
  loop:
    - Dockerfile
    - .dockerignore

- name: Build docker image
  shell: 'docker build -t {{ image_name }}/webclient:{{ version }} .'
  args:
    chdir: '{{ workspace }}'
  when: lookup('env', 'JENKINS_HOME')

- name: Push docker image to dockerhub.web-essentials.co
  shell: 'docker push {{ image_name }}/webclient:{{ version }}'
  args:
    chdir: '{{ workspace }}'
  when: lookup('env', 'JENKINS_HOME')

- name: Wait for containers ready
  pause:
    seconds: 30

### Admin Service

- name: Admin-Service | Get running admin service pod name
  shell: 'KUBECONFIG={{ kubeconfig }} kubectl get pods -n {{ k8s_namespace }} | grep app-{{ stage }}-{{ project_name }}-admin-service | cut -d " " -f1'
  register: pod_name
  when: lookup('env', 'JENKINS_HOME')

- name: Admin-Service | Migrate DB
  shell: 'KUBECONFIG={{ kubeconfig }} kubectl exec {{ pod_name.stdout }} -n {{ k8s_namespace }} -- /usr/bin/php artisan migrate --force &'
  when: lookup('env', 'JENKINS_HOME')

- name: Admin-Service | Link storage folder to public
  shell: 'KUBECONFIG={{ kubeconfig }} kubectl exec {{ pod_name.stdout }} -n {{ k8s_namespace }} -- /usr/bin/php artisan storage:link &'
  when: lookup('env', 'JENKINS_HOME')

- name: Admin-Service | Clear caches
  shell: 'KUBECONFIG={{ kubeconfig }} kubectl exec {{ pod_name.stdout }} -n {{ k8s_namespace }} -- /usr/bin/php artisan {{ item }} &'
  loop:
    - cache:clear
    - config:clear
    - view:clear
    - route:clear

### Therapist Service

- name: Therapist-Service | Get running admin service pod name
  shell: 'KUBECONFIG={{ kubeconfig }} kubectl get pods -n {{ k8s_namespace }} | grep app-{{ stage }}-{{ project_name }}-therapist-service | cut -d " " -f1'
  register: therapist_pod_name
  when: lookup('env', 'JENKINS_HOME')

- name: Therapist-Service | Migrate DB
  shell: 'KUBECONFIG={{ kubeconfig }} kubectl exec {{ therapist_pod_name.stdout }} -n {{ k8s_namespace }} -- /usr/bin/php artisan migrate --force &'
  when: lookup('env', 'JENKINS_HOME')

- name: Therapist-Service | Link storage folder to public
  shell: 'KUBECONFIG={{ kubeconfig }} kubectl exec {{ therapist_pod_name.stdout }} -n {{ k8s_namespace }} -- /usr/bin/php artisan storage:link &'
  when: lookup('env', 'JENKINS_HOME')

- name: Therapist-Service | Clear caches
  shell: 'KUBECONFIG={{ kubeconfig }} kubectl exec {{ therapist_pod_name.stdout }} -n {{ k8s_namespace }} -- /usr/bin/php artisan {{ item }} &'
  loop:
    - cache:clear
    - config:clear
    - view:clear
    - route:clear

- name: Deploy webclient
  shell: 'KUBECONFIG={{ kubeconfig }} kubectl apply -f {{ workspace }}/k8s-deploy/webclient.yml'
  when: lookup('env', 'JENKINS_HOME')