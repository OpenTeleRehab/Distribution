---

- name: Login to nexus docker private repo
  docker_login:
    registry: '{{ hub_registry }}'
    username: '{{ hub_user }}'
    password: '{{ hub_pass }}'

- name: Deploy k8s namespace pvc configmap
  import_tasks: deploy-k8s-common.yml
  when: stage != 'live'

- name: Git clone all repositories into workspace (Admin, Therapist, Patient)
  import_tasks: clone-projects.yml

### Build Docker image Admin Service
- name: Check build file if exist for Admin service
  stat:
    path: '/var/tmp/{{ project_id }}/{{ stage }}-admin-service-build'
  register: admin_service_build

- name: Build Admin service
  import_tasks: admin-service.yml
  when: admin_service_build.stat.exists

### Build Docker image Admin Webapp
- name: Check build file if exist for Admin webapp
  stat:
    path: '/var/tmp/{{ project_id }}/{{ stage }}-admin-webapp-build'
  register: admin_webapp_build

- name: Build Admin webapp
  import_tasks: admin-webapp.yml
  when: admin_webapp_build.stat.exists

### Build Docker image Therapist Service
- name: Check build file if exist for Admin webapp
  stat:
    path: '/var/tmp/{{ project_id }}/{{ stage }}-therapist-service-build'
  register: therapist_service_build

- name: Build Therapist service
  import_tasks: therapist-service.yml
  when: therapist_service_build.stat.exists

### Build Docker image Therapist Webapp
- name: Check build file if exist for Admin webapp
  stat:
    path: '/var/tmp/{{ project_id }}/{{ stage }}-therapist-webapp-build'
  register: therapist_webapp_build

- name: Build Therapist webapp
  import_tasks: therapist-webapp.yml
  when: therapist_webapp_build.stat.exists

### Build Docker image Patient Service
- name: Check build file if exist for Patient service
  stat:
    path: '/var/tmp/{{ project_id }}/{{ stage }}-patient-service-build'
  register: patient_service_build

- name: Build Therapist service
  import_tasks: patient-service.yml
  when: patient_service_build.stat.exists

### Build webclient
- name: Build Therapist webapp
  import_tasks: webclient.yml

### Deploy k8s pods
- name: Deploy deploy services
  import_tasks: deploy-k8s-services.yml
  when: stage != 'live'
